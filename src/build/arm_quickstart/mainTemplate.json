{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "servicePrincipalId": {
        "type": "string",
        "metadata": {
          "description": "A pre-generate service principal with contributor role attached for running the deployment."
        }
      },
      "servicePrincipalSecret": {
        "type": "securestring",
        "metadata": {
          "description": "The sercret key for the service pincipal you created."
        }
      },
      "subscriptionId": {
        "type": "string",
        "defaultValue": "[subscription().subscriptionId]",
        "metadata": {
          "description": "Subscription ID for MissionLZ resources (defaults to context subscription)"
        }
      },
      "mlzLocation": {
        "type": "string",
        "defaultValue": "eastus",
        "metadata": {
          "description": "The location that you're deploying to, defaults to selected resource group location."
        }
      },
      "tfEnvironment": {
        "type": "string",
        "defaultValue": "public",
        "metadata": {
          "description": "Terraform azurerm environment (defaults to 'public') see: https://www.terraform.io/docs/language/settings/backends/azurerm.html#environment"
        }
      },
      "mlzEnvName": {
        "type": "string",
        "defaultValue": "[concat('mlz', parameters('utcValue'))]",
        "metadata": {
          "description": "The location that you're deploying to"
        }
      },
      "noBastion": {
        "type": "bool",
        "defaultValue": "true",
        "metadata": {
          "description": "If any value is present, will not create Bastion Host and Jumpbox VM"
        }
      },
      "noSentinel": {
        "type": "bool",
        "defaultValue": "true",
        "metadata": {
          "description": "If any value is present, will not create an Azure Sentinel solution"
        }
      },
      "utcValue": {
        "type": "string",
        "defaultValue": "[utcNow()]"
      }
    },
   "resources": [
      {
        "type": "Microsoft.Resources/deploymentScripts",
        "apiVersion": "2020-10-01",
        "name": "[concat('deployMLZ', parameters('utcValue'))]",
        "location": "[resourceGroup().location]",
        "kind": "AzureCLI",
        "properties": {
          "forceUpdateTag": "[parameters('utcValue')]",
          "azCliVersion": "2.15.0",
          "timeout": "PT120M",
          "environmentVariables":[
            {
              "name": "TERRAFORM_VERSION",
              "value": "1.0.3"
            },
            {
              "name": "ARM_CLIENT_ID",
              "value": "[parameters('servicePrincipalId')]"
            },
            {
              "name": "ARM_CLIENT_SECRET",
              "value": "[parameters('servicePrincipalSecret')]"
            },
            {
              "name": "env_tenant_id",
              "value": "[subscription().tenantId]"
            },
            {
              "name": "subscription_id",
              "value": "[parameters('subscriptionId')]"
            },
             {
              "name": "mlz_location",
              "value": "[parameters('mlzLocation')]"
            },
             {
              "name": "tf_environment",
              "value": "[parameters('tfEnvironment')]"
            },
             {
              "name": "mlz_env_name",
              "value": "[parameters('mlzEnvName')]"
            },
              {
              "name": "no_bastion",
              "value": "[parameters('noBastion')]"
            },
              {
              "name": "no_sentinel",
              "value": "[parameters('noSentinel')]"
            }
          ],
          "primaryScriptUri": "https://raw.githubusercontent.com/Azure/missionlz/main/src/build/arm_quickstart/arm_deploy.sh",
          "cleanupPreference": "OnExpiration",
          "retentionInterval": "P1D"
        }
      }
    ]
  }
